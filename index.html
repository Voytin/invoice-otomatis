<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Praktis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0; /* Pastel Cream */
        }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white; padding: 0; }
            .invoice-paper {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
        }

        .invoice-paper {
            background: white;
            min-height: 297mm;
            width: 210mm;
            margin: 2rem auto;
            padding: 4rem;
            box-shadow: 0 20px 25px -5px rgba(139, 94, 60, 0.1), 0 10px 10px -5px rgba(139, 94, 60, 0.04);
            position: relative;
            border-top: 8px solid #8b5a2b; /* Wood Accent */
        }

        [contenteditable]:focus {
            outline: 2px dashed #a0522d;
            outline-offset: 4px;
            background-color: #fdfaf6;
        }

        .item-textarea {
            @apply w-full bg-transparent border-b border-transparent focus:border-[#a0522d] outline-none transition-all py-1 resize-none overflow-hidden block;
            min-height: 1.5rem;
            line-height: 1.5;
        }

        .item-input {
            @apply w-full bg-transparent border-b border-transparent focus:border-[#a0522d] outline-none transition-all py-1 block;
        }

        /* Custom Scrollbar Wood Theme */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d2b48c; border-radius: 10px; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* Wood Texture Accent for UI */
        .wood-gradient {
            background: linear-gradient(135deg, #8b5a2b 0%, #a0522d 100%);
        }
        
        .pastel-wood-bg {
            background-color: #eaddd0;
        }
    </style>
</head>
<body class="p-4">

    <!-- Top Navigation Bar -->
    <div class="no-print sticky top-0 z-50 max-w-5xl mx-auto mb-6 flex flex-col md:flex-row items-center justify-between bg-white/90 backdrop-blur-md p-4 rounded-2xl shadow-md border border-[#eaddd0] gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-extrabold text-[#5d4037] tracking-tight italic">Invoice<span class="text-[#a0522d]">Praktis</span></h1>
            <div id="cloud-status" class="flex items-center gap-1.5 text-[10px] font-bold uppercase px-3 py-1 rounded-full bg-[#fdfaf6] text-[#8d6e63] border border-[#eaddd0]">
                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                Menghubungkan
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="createNewInvoice()" class="bg-white border border-[#d2b48c] hover:bg-[#fdfaf6] text-[#8b5a2b] px-4 py-2 rounded-lg text-sm font-bold transition-all">Baru</button>
            <button id="btn-save" class="wood-gradient hover:opacity-90 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Simpan
            </button>
            <button onclick="window.print()" class="bg-[#5d4037] hover:bg-[#3e2723] text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Cetak PDF
            </button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row max-w-[1400px] mx-auto gap-8 items-start">
        
        <!-- History Sidebar -->
        <div class="no-print w-full lg:w-72 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-[#eaddd0]">
                <h2 class="text-xs font-black text-[#a1887f] uppercase tracking-widest mb-4">Riwayat Draf</h2>
                <div id="draft-list" class="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-xs text-slate-400 italic text-center py-4">Memuat data...</p>
                </div>
            </div>
        </div>

        <!-- MAIN INVOICE PAPER -->
        <div id="invoice-paper" class="invoice-paper">
            <!-- Logo Section -->
            <div class="flex justify-between items-start mb-16">
                <div class="flex flex-col gap-2">
                    <div class="relative group">
                        <input type="file" id="logo-upload" class="hidden" accept="image/*">
                        <div id="logo-container" onclick="document.getElementById('logo-upload').click()" class="min-w-[10rem] min-h-[5rem] flex flex-col items-center justify-center cursor-pointer hover:bg-[#fdfaf6] transition-all overflow-hidden relative">
                            <div id="logo-placeholder" class="text-center p-4">
                                <svg class="mx-auto text-[#d2b48c]" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                <p class="text-[9px] font-bold text-[#a1887f] mt-2 uppercase tracking-tighter">Upload Logo</p>
                            </div>
                            <img id="logo-img" class="h-auto object-contain w-[160px] hidden" src="">
                            <button onclick="event.stopPropagation(); removeLogo()" id="remove-logo" class="no-print absolute -top-1 -right-1 bg-red-400 text-white rounded-full p-1 shadow-md hover:bg-red-500 transition-colors hidden">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div id="logo-size-control" class="no-print flex flex-col gap-1 px-1 hidden">
                        <label class="text-[8px] font-black text-[#d2b48c] uppercase">Ukuran Logo</label>
                        <input type="range" id="logo-size-slider" min="50" max="350" value="160" oninput="resizeLogo(this.value)" class="w-full h-1 bg-[#eaddd0] rounded-lg appearance-none cursor-pointer accent-[#8b5a2b]">
                    </div>
                </div>

                <div class="text-right">
                    <h2 contenteditable="true" id="inv-title" class="text-5xl font-black text-[#8b5a2b] italic tracking-tighter mb-1 uppercase">INVOICE</h2>
                    <div class="text-[#8d6e63] font-bold text-sm">
                        <p># <span contenteditable="true" id="inv-no">INV/2026/001</span></p>
                        <p class="mt-0.5"><span contenteditable="true" id="inv-date-label">Tanggal:</span> <span contenteditable="true" id="inv-date">26 Feb 2026</span></p>
                    </div>
                </div>
            </div>

            <!-- Addresses -->
            <div class="grid grid-cols-2 gap-12 mb-12">
                <div>
                    <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-3 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Pengirim</h3>
                    <div contenteditable="true" id="from-info" class="text-sm font-semibold text-[#5d4037] leading-relaxed whitespace-pre-line">
                        Nama Perusahaan Anda
                        Jl. Contoh No. 123, Kota
                        Telp: 0812-XXXX-XXXX
                    </div>
                </div>
                <div class="text-right">
                    <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-3 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Penerima</h3>
                    <div contenteditable="true" id="to-info" class="text-sm font-semibold text-[#5d4037] leading-relaxed whitespace-pre-line">
                        Nama Customer / Instansi
                        Alamat Lengkap Customer
                        Kontak Penerima
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="mb-8">
                <table class="w-full text-left table-fixed">
                    <thead>
                        <tr class="bg-[#5d4037] text-[#f7f3f0]">
                            <th class="py-3 px-3 text-[9px] uppercase font-black tracking-widest rounded-l-lg w-12 text-center">No</th>
                            <th class="py-3 px-4 text-[9px] uppercase font-black tracking-widest w-auto text-left">Item Pekerjaan</th>
                            <th class="py-3 px-2 text-[9px] uppercase font-black tracking-widest text-center w-16">Qty</th>
                            <th class="py-3 px-2 text-[9px] uppercase font-black tracking-widest text-center w-20">Satuan</th>
                            <th class="py-3 px-2 text-[9px] uppercase font-black tracking-widest text-right w-36">Harga Satuan</th>
                            <th class="py-3 px-4 text-[9px] uppercase font-black tracking-widest text-right w-36 rounded-r-lg">Total</th>
                        </tr>
                    </thead>
                    <tbody id="items-body">
                        <!-- Rendered by JS -->
                    </tbody>
                </table>
                <button onclick="addItem()" class="no-print mt-4 flex items-center gap-1.5 text-[#a0522d] font-black text-[10px] uppercase tracking-wider hover:text-[#8b4513] transition-all">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Tambah Baris Baru
                </button>
            </div>

            <!-- Notes Section -->
            <div class="mb-12">
                <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-2 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Catatan Tambahan</h3>
                <div contenteditable="true" id="invoice-notes" class="text-[11px] font-medium text-[#8d6e63] leading-relaxed min-h-[4rem] whitespace-pre-line">
                    * Pembayaran dapat dikirim melalui Rekening Bank XXXX: 1234-5678-90 (A/N Nama Anda)
                </div>
            </div>

            <!-- Totals Section -->
            <div class="flex justify-end pt-8 border-t-4 border-[#f7f3f0]">
                <div class="w-full md:w-[26rem] space-y-3">
                    <div class="flex justify-between items-center text-sm font-bold text-[#d2b48c] px-4">
                        <span>Subtotal:</span>
                        <span id="p-subtotal">Rp 0</span>
                    </div>

                    <!-- Discount UI -->
                    <div class="no-print group flex items-center justify-between bg-[#fdfaf6] p-2.5 rounded-xl border border-[#eaddd0] hover:border-[#d2b48c] transition-all">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-black text-[#a1887f] uppercase">Diskon</span>
                            <div class="flex bg-white rounded-md border border-[#eaddd0] overflow-hidden text-[9px]">
                                <button onclick="setMode('discount', 'percent')" id="mode-discount-percent" class="px-2 py-1 font-black transition-all bg-[#a0522d] text-white">%</button>
                                <button onclick="setMode('discount', 'fixed')" id="mode-discount-fixed" class="px-2 py-1 font-black transition-all text-[#d2b48c]">Rp</button>
                            </div>
                        </div>
                        <input type="number" id="discount-input" value="0" oninput="calculateTotals()" class="bg-transparent text-right font-black text-[#a0522d] outline-none w-24 text-sm">
                    </div>
                    
                    <div class="print-only flex justify-between items-center text-xs font-bold text-[#c62828] px-4">
                        <span id="p-discount-label">Diskon:</span>
                        <span id="p-discount-amount">- Rp 0</span>
                    </div>

                    <!-- TOTAL -->
                    <div class="flex justify-between items-center text-2xl font-black text-white wood-gradient p-5 rounded-2xl shadow-xl shadow-[#8b5a2b1a]">
                        <span class="tracking-tighter italic text-base">TOTAL TAGIHAN</span>
                        <span id="p-total">Rp 0</span>
                    </div>

                    <!-- DP Section -->
                    <div class="space-y-3" id="dp-section-container">
                        <div class="no-print flex items-center justify-end gap-2 px-4 pt-1">
                            <span class="text-[9px] font-black text-[#d2b48c] uppercase">Aktifkan DP</span>
                            <button onclick="toggleDP()" id="dp-master-toggle" class="w-8 h-4 rounded-full bg-[#eaddd0] relative transition-all">
                                <span class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full shadow-sm transition-all transform translate-x-0" id="dp-toggle-knob"></span>
                            </button>
                        </div>

                        <div id="dp-controls" class="hidden no-print flex items-center justify-between bg-[#f1f8e9] p-2.5 rounded-xl border border-[#c5e1a5]">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black text-[#558b2f] uppercase">Uang Muka (DP)</span>
                                <div class="flex bg-white rounded-md border border-[#c5e1a5] overflow-hidden text-[9px]">
                                    <button onclick="setMode('dp', 'percent')" id="mode-dp-percent" class="px-2 py-1 font-black text-[#9ccc65]">%</button>
                                    <button onclick="setMode('dp', 'fixed')" id="mode-dp-fixed" class="px-2 py-1 font-black bg-[#689f38] text-white">Rp</button>
                                </div>
                            </div>
                            <input type="number" id="dp-input" value="0" oninput="calculateTotals()" class="bg-transparent text-right font-black text-[#33691e] outline-none w-24 text-sm">
                        </div>

                        <div id="dp-display-row" class="hidden flex justify-between items-center text-xs font-bold text-[#558b2f] px-4 italic">
                            <span id="p-dp-label">Sudah Dibayar (DP):</span>
                            <span id="p-dp-amount">- Rp 0</span>
                        </div>

                        <div id="balance-display-row" class="hidden flex justify-between items-center text-base font-black text-[#5d4037] border-t-2 border-[#f7f3f0] pt-4 px-4">
                            <span class="uppercase tracking-widest text-[11px]">Sisa Pembayaran</span>
                            <span id="p-balance" class="text-[#a0522d]">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signatures -->
            <div class="mt-24 grid grid-cols-2 gap-16 text-center">
                <div>
                    <p contenteditable="true" id="to-label" class="text-[10px] uppercase font-black text-[#d2b48c] mb-20 tracking-[0.2em]">Diterima Oleh,</p>
                    <div class="border-b-2 border-[#eaddd0] mx-auto w-52 mb-2"></div>
                    <div contenteditable="true" id="to-name" class="font-black text-[#5d4037] tracking-tight uppercase">( Nama Penerima )</div>
                </div>
                <div>
                    <p contenteditable="true" id="from-label" class="text-[10px] uppercase font-black text-[#d2b48c] mb-20 tracking-[0.2em]">Hormat Kami,</p>
                    <div class="border-b-2 border-[#eaddd0] mx-auto w-52 mb-2"></div>
                    <div contenteditable="true" id="from-name" class="font-black text-[#5d4037] tracking-tight uppercase">( Penanggung Jawab )</div>
                </div>
            </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 wood-gradient text-white px-8 py-3 rounded-full text-[10px] font-black uppercase tracking-widest opacity-0 transition-all duration-300 pointer-events-none z-[100] shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userProvidedConfig = {
            apiKey: "AIzaSyAycsHtCJTx5vFzt-Ts7C4b-TC6XPg0Jew",
            authDomain: "cloud-invoice-31eb4.firebaseapp.com",
            projectId: "cloud-invoice-31eb4",
            storageBucket: "cloud-invoice-31eb4.firebasestorage.app",
            messagingSenderId: "581810444397",
            appId: "1:581810444397:web:3c677edd12f5258ed34764"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'invoice-cloud-v2';

        let currentUser = null;
        let currentDraftId = null;
        let items = [{ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false }];
        let discountMode = 'percent'; 
        let dpMode = 'fixed';
        let dpEnabled = false; 
        let logoBase64 = null;
        let logoWidth = 160;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { console.error(err); updateCloudStatus('error'); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                updateCloudStatus('connected');
                listenToDrafts();
            }
        });

        window.addItem = () => {
            items.push({ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false });
            renderItems();
        };

        window.removeItem = (id) => {
            if (items.length <= 1) {
                items = [{ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false }];
            } else {
                items = items.filter(i => i.id !== id);
            }
            renderItems();
        };

        window.toggleHeader = (id) => {
            const item = items.find(i => i.id === id);
            if (item) {
                item.isHeader = !item.isHeader;
                renderItems();
            }
        };

        const autoResize = (el) => {
            if (!el) return;
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        };

        window.updateItem = (id, field, val) => {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = (field === 'quantity' || field === 'price') ? (parseFloat(val) || 0) : val;
                
                const rowTotalEl = document.getElementById(`row-total-val-${id}`);
                if (rowTotalEl) {
                    rowTotalEl.textContent = formatCurrency(item.quantity * item.price);
                }

                if (field === 'description') {
                    const el = document.getElementById(`desc-${id}`);
                    autoResize(el);
                    
                    if (val.trim() !== '') {
                        const idx = items.indexOf(item);
                        if (idx === items.length - 1) {
                            items.push({ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false });
                            renderItems(); 
                            return;
                        }
                    }
                }
                calculateTotals();
            }
        };

        window.renderItems = () => {
            const tbody = document.getElementById('items-body');
            const activeId = document.activeElement ? document.activeElement.id : null;
            const start = document.activeElement ? document.activeElement.selectionStart : null;
            const end = document.activeElement ? document.activeElement.selectionEnd : null;
            
            tbody.innerHTML = '';
            let headerCounter = 0;

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = `border-b border-[#f7f3f0] group hover:bg-[#fdfaf6] transition-all relative ${item.isHeader ? 'bg-[#fdfaf6] font-bold' : ''}`;
                
                let displayNo = '';
                if (item.isHeader) {
                    headerCounter++;
                    displayNo = headerCounter;
                }

                tr.innerHTML = `
                    <td class="py-4 px-3 text-center text-xs text-[#a1887f] font-bold align-top">
                        ${displayNo}
                    </td>
                    <td class="py-4 px-4 relative align-top">
                        <div class="no-print absolute -left-12 top-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="removeItem(${item.id})" title="Hapus Baris" class="bg-red-50 text-red-400 p-1 rounded hover:bg-red-400 hover:text-white">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                            <button onclick="toggleHeader(${item.id})" title="${item.isHeader ? 'Jadikan Sub-item' : 'Jadikan Header Area'}" class="p-1 rounded ${item.isHeader ? 'bg-[#a0522d] text-white' : 'bg-[#eaddd0] text-[#8d6e63] hover:bg-[#d2b48c]'}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            </button>
                        </div>
                        <textarea id="desc-${item.id}" 
                            placeholder="${item.isHeader ? 'Nama Area/Lantai...' : 'Rincian pekerjaan...'}" 
                            oninput="updateItem(${item.id}, 'description', this.value)" 
                            class="item-textarea ${item.isHeader ? 'font-extrabold text-[#8b5a2b]' : 'font-semibold text-[#5d4037]'}">${item.description}</textarea>
                    </td>
                    <td class="py-4 px-2 align-top text-center">
                        <input type="number" id="qty-${item.id}" value="${item.quantity}" oninput="updateItem(${item.id}, 'quantity', this.value)" class="w-full text-center bg-transparent font-bold text-[#5d4037] outline-none ${item.isHeader ? 'invisible' : ''}">
                    </td>
                    <td class="py-4 px-2 align-top text-center">
                        <input type="text" id="unit-${item.id}" value="${item.unit}" placeholder="..." oninput="updateItem(${item.id}, 'unit', this.value)" class="w-full text-center bg-transparent font-bold text-[#a1887f] outline-none text-[11px] ${item.isHeader ? 'invisible' : ''}">
                    </td>
                    <td class="py-4 px-2 align-top text-right">
                        <input type="number" id="price-${item.id}" value="${item.price}" oninput="updateItem(${item.id}, 'price', this.value)" class="w-full text-right bg-transparent font-bold text-[#5d4037] outline-none ${item.isHeader ? 'invisible' : ''}">
                    </td>
                    <td class="py-4 px-4 text-right font-black text-[#5d4037] text-sm align-top">
                        <span id="row-total-val-${item.id}" class="${item.isHeader ? 'invisible' : ''}">${formatCurrency(item.quantity * item.price)}</span>
                    </td>
                `;
                tbody.appendChild(tr);
                
                const txt = document.getElementById(`desc-${item.id}`);
                autoResize(txt);
            });

            if (activeId) {
                const el = document.getElementById(activeId);
                if (el) {
                    el.focus();
                    if (start !== null && end !== null && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
                        el.setSelectionRange(start, end);
                    }
                }
            }
            calculateTotals();
        };

        window.toggleDP = () => {
            dpEnabled = !dpEnabled;
            const toggle = document.getElementById('dp-master-toggle');
            const knob = document.getElementById('dp-toggle-knob');
            const controls = document.getElementById('dp-controls');
            const displayRow = document.getElementById('dp-display-row');
            const balanceRow = document.getElementById('balance-display-row');

            if (dpEnabled) {
                toggle.classList.replace('bg-[#eaddd0]', 'bg-[#689f38]');
                knob.classList.replace('translate-x-0', 'translate-x-4');
                controls.classList.remove('hidden');
                displayRow.classList.remove('hidden');
                balanceRow.classList.remove('hidden');
            } else {
                toggle.classList.replace('bg-[#689f38]', 'bg-[#eaddd0]');
                knob.classList.replace('translate-x-4', 'translate-x-0');
                controls.classList.add('hidden');
                displayRow.classList.add('hidden');
                balanceRow.classList.add('hidden');
            }
            calculateTotals();
        };

        window.setMode = (type, mode) => {
            if (type === 'discount') {
                discountMode = mode;
                document.getElementById('mode-discount-percent').className = `px-2 py-1 font-black transition-all ${mode === 'percent' ? 'bg-[#a0522d] text-white' : 'text-[#d2b48c] bg-white'}`;
                document.getElementById('mode-discount-fixed').className = `px-2 py-1 font-black transition-all ${mode === 'fixed' ? 'bg-[#a0522d] text-white' : 'text-[#d2b48c] bg-white'}`;
            } else if (type === 'dp') {
                dpMode = mode;
                document.getElementById('mode-dp-percent').className = `px-2 py-1 font-black transition-all ${mode === 'percent' ? 'bg-[#689f38] text-white' : 'text-[#9ccc65] bg-white'}`;
                document.getElementById('mode-dp-fixed').className = `px-2 py-1 font-black transition-all ${mode === 'fixed' ? 'bg-[#689f38] text-white' : 'text-[#9ccc65] bg-white'}`;
            }
            calculateTotals();
        };

        window.calculateTotals = () => {
            const subtotal = items.reduce((s, i) => s + (i.isHeader ? 0 : (i.quantity * i.price)), 0);
            const discVal = parseFloat(document.getElementById('discount-input').value) || 0;
            let discAmount = discountMode === 'percent' ? (subtotal * discVal) / 100 : discVal;
            const invoiceTotal = Math.max(0, subtotal - discAmount);

            let dpAmount = 0;
            let remainingBalance = invoiceTotal;
            if (dpEnabled) {
                const dpVal = parseFloat(document.getElementById('dp-input').value) || 0;
                dpAmount = dpMode === 'percent' ? (invoiceTotal * dpVal) / 100 : dpVal;
                remainingBalance = Math.max(0, invoiceTotal - dpAmount);
            }

            document.getElementById('p-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('p-discount-label').textContent = discountMode === 'percent' ? `Potongan Diskon (${discVal}%):` : 'Potongan Diskon:';
            document.getElementById('p-discount-amount').textContent = `- ${formatCurrency(discAmount)}`;
            document.getElementById('p-total').textContent = formatCurrency(invoiceTotal);
            
            if (dpEnabled) {
                const dpInputVal = parseFloat(document.getElementById('dp-input').value) || 0;
                document.getElementById('p-dp-label').textContent = dpMode === 'percent' ? `DP Dibayarkan (${dpInputVal}%):` : 'DP Dibayarkan:';
                document.getElementById('p-dp-amount').textContent = `- ${formatCurrency(dpAmount)}`;
                document.getElementById('p-balance').textContent = formatCurrency(remainingBalance);
            }
        };

        document.getElementById('logo-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    logoBase64 = event.target.result;
                    displayLogo(logoBase64);
                };
                reader.readAsDataURL(file);
            }
        };

        window.resizeLogo = (val) => {
            logoWidth = val;
            const img = document.getElementById('logo-img');
            if (img) img.style.width = `${val}px`;
        };

        function displayLogo(src, width) {
            const img = document.getElementById('logo-img');
            const placeholder = document.getElementById('logo-placeholder');
            const removeBtn = document.getElementById('remove-logo');
            const control = document.getElementById('logo-size-control');
            const slider = document.getElementById('logo-size-slider');
            const actualWidth = width || logoWidth;
            logoWidth = actualWidth;
            slider.value = actualWidth;
            img.src = src;
            img.style.width = `${actualWidth}px`;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
            removeBtn.classList.remove('hidden');
            control.classList.remove('hidden');
        }

        window.removeLogo = () => {
            logoBase64 = null;
            const img = document.getElementById('logo-img');
            const placeholder = document.getElementById('logo-placeholder');
            const removeBtn = document.getElementById('remove-logo');
            const control = document.getElementById('logo-size-control');
            img.classList.add('hidden');
            img.src = "";
            placeholder.classList.remove('hidden');
            removeBtn.classList.add('hidden');
            control.classList.add('hidden');
            document.getElementById('logo-upload').value = '';
        };

        window.createNewInvoice = () => {
            currentDraftId = null;
            document.getElementById('inv-no').textContent = 'INV/' + new Date().getFullYear() + '/' + Math.floor(Math.random()*1000).toString().padStart(3,'0');
            document.getElementById('inv-date').textContent = new Intl.DateTimeFormat('id-ID', {day:'numeric', month:'short', year:'numeric'}).format(new Date());
            document.getElementById('from-info').textContent = 'Nama Perusahaan\nAlamat\nKontak';
            document.getElementById('to-info').textContent = 'Nama Penerima\nAlamat Customer';
            document.getElementById('invoice-notes').textContent = '* Pembayaran dapat dikirim melalui Rekening Bank XXXX: 1234-5678-90 (A/N Nama Anda)';
            document.getElementById('discount-input').value = 0;
            document.getElementById('dp-input').value = 0;
            if (dpEnabled) toggleDP(); 
            removeLogo();
            items = [{ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false }];
            renderItems();
            showToast("Invoice Baru Kosong Dibuat");
        };

        window.saveDraft = async () => {
            if (!currentUser) return showToast("Koneksi Error (Offline)");
            const id = currentDraftId || crypto.randomUUID();
            const data = {
                invTitle: document.getElementById('inv-title').textContent,
                invNo: document.getElementById('inv-no').textContent,
                invDate: document.getElementById('inv-date').textContent,
                fromInfo: document.getElementById('from-info').textContent,
                fromLabel: document.getElementById('from-label').textContent,
                fromName: document.getElementById('from-name').textContent,
                toInfo: document.getElementById('to-info').textContent,
                toLabel: document.getElementById('to-label').textContent,
                toName: document.getElementById('to-name').textContent,
                notes: document.getElementById('invoice-notes').textContent,
                items: items,
                discountValue: parseFloat(document.getElementById('discount-input').value) || 0,
                discountMode: discountMode,
                dpEnabled: dpEnabled,
                dpValue: parseFloat(document.getElementById('dp-input').value) || 0,
                dpMode: dpMode,
                logo: logoBase64,
                logoWidth: logoWidth,
                updatedAt: serverTimestamp()
            };
            try {
                const path = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id);
                await setDoc(path, data);
                currentDraftId = id;
                showToast("Berhasil Disimpan ke Cloud");
            } catch (e) { showToast("Gagal Menyimpan"); }
        };

        function listenToDrafts() {
            const col = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices');
            onSnapshot(col, (snap) => {
                const list = document.getElementById('draft-list');
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<p class="text-[10px] text-slate-400 text-center py-4 italic">Belum ada draf</p>';
                    return;
                }
                snap.docs.forEach(docSnap => {
                    const d = docSnap.data();
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl border text-[11px] cursor-pointer transition-all ${currentDraftId === docSnap.id ? 'wood-gradient text-white border-transparent' : 'bg-white hover:bg-[#fdfaf6] border-[#eaddd0] text-[#8d6e63]'}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-center" onclick="loadDraft('${docSnap.id}')">
                            <span class="font-black truncate mr-2">${d.invNo}</span>
                            <button onclick="event.stopPropagation(); deleteDraft('${docSnap.id}')" class="opacity-50 hover:opacity-100"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path></svg></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.loadDraft = (id) => {
            onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id), (snap) => {
                if (!snap.exists()) return;
                const d = snap.data();
                currentDraftId = id;
                document.getElementById('inv-title').textContent = d.invTitle;
                document.getElementById('inv-no').textContent = d.invNo;
                document.getElementById('inv-date').textContent = d.invDate;
                document.getElementById('from-info').textContent = d.fromInfo;
                document.getElementById('from-label').textContent = d.fromLabel;
                document.getElementById('from-name').textContent = d.fromName;
                document.getElementById('to-info').textContent = d.toInfo;
                document.getElementById('to-label').textContent = d.toLabel;
                document.getElementById('to-name').textContent = d.toName;
                document.getElementById('invoice-notes').textContent = d.notes || "";
                document.getElementById('discount-input').value = d.discountValue || 0;
                document.getElementById('dp-input').value = d.dpValue || 0;
                if (d.dpEnabled !== dpEnabled) toggleDP(); 
                items = d.items;
                discountMode = d.discountMode || 'percent';
                dpMode = d.dpMode || 'fixed';
                logoBase64 = d.logo;
                logoWidth = d.logoWidth || 160;
                if (logoBase64) displayLogo(logoBase64, logoWidth); else removeLogo();
                setMode('discount', discountMode);
                setMode('dp', dpMode);
                renderItems();
                showToast("Draf Berhasil Dimuat");
            }, {onlyOnce: true});
        };

        window.deleteDraft = async (id) => {
            if (!confirm("Hapus draf ini dari Cloud?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id));
            if (currentDraftId === id) createNewInvoice();
        };

        function formatCurrency(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m; t.classList.add('opacity-100', 'translate-y-[-10px]');
            setTimeout(() => t.classList.remove('opacity-100', 'translate-y-[-10px]'), 3000);
        }
        function updateCloudStatus(s) {
            const el = document.getElementById('cloud-status');
            const dot = el.querySelector('span');
            if (s === 'connected') {
                el.className = "flex items-center gap-1.5 text-[10px] font-bold uppercase px-3 py-1 rounded-full bg-[#f1f8e9] text-[#558b2f] border border-[#c5e1a5]";
                dot.className = "w-2 h-2 rounded-full bg-[#8bc34a] animate-pulse";
                el.lastChild.textContent = "Cloud Aktif";
            } else {
                el.className = "flex items-center gap-1.5 text-[10px] font-bold uppercase px-3 py-1 rounded-full bg-red-50 text-red-400 border border-red-100";
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                el.lastChild.textContent = "Offline";
            }
        }

        document.getElementById('btn-save').onclick = window.saveDraft;
        window.renderItems();
    </script>
</body>
</html>
