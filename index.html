<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Praktis - DP Bertahap & Toolbar Perataan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0;
        }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white; padding: 0; }
            .invoice-paper {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
        }

        .invoice-paper {
            background: white;
            min-height: 297mm;
            width: 210mm;
            margin: 2rem auto;
            padding: 3.5rem;
            box-shadow: 0 20px 25px -5px rgba(139, 94, 60, 0.1);
            position: relative;
            border-top: 8px solid #8b5a2b;
        }

        [contenteditable]:focus {
            outline: none;
            background-color: #fdfaf6;
            border-bottom: 2px dashed #d2b48c;
        }

        .item-textarea {
            @apply w-full bg-transparent border-b border-transparent focus:border-[#a0522d] outline-none transition-all py-1 resize-none overflow-hidden block;
            min-height: 1.5rem;
            line-height: 1.5;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d2b48c; border-radius: 10px; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .wood-gradient {
            background: linear-gradient(135deg, #8b5a2b 0%, #a0522d 100%);
        }

        .active-row {
            background-color: #fdfaf6;
            border-left: 3px solid #d2b48c;
        }
    </style>
</head>
<body class="p-4">

    <!-- Top Navigation Bar -->
    <div class="no-print sticky top-0 z-50 max-w-5xl mx-auto mb-6 flex flex-col md:flex-row items-center justify-between bg-white/95 backdrop-blur-md p-4 rounded-2xl shadow-md border border-[#eaddd0] gap-4">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-extrabold text-[#5d4037] tracking-tight italic">Invoice<span class="text-[#a0522d]">Praktis</span></h1>
            <div id="cloud-status" class="flex items-center gap-1.5 text-[10px] font-bold uppercase px-3 py-1 rounded-full bg-[#fdfaf6] text-[#8d6e63] border border-[#eaddd0]">
                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                Menghubungkan
            </div>
        </div>

        <div class="flex gap-2">
            <button onclick="createNewInvoice()" class="bg-white border border-[#d2b48c] hover:bg-[#fdfaf6] text-[#8b5a2b] px-4 py-2 rounded-lg text-sm font-bold transition-all">Baru</button>
            <button id="btn-save" class="wood-gradient hover:opacity-90 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                Simpan
            </button>
            <button onclick="window.print()" class="bg-[#5d4037] hover:bg-[#3e2723] text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Cetak PDF
            </button>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row max-w-[1400px] mx-auto gap-8 items-start">
        
        <!-- History Sidebar -->
        <div class="no-print w-full lg:w-72 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-[#eaddd0]">
                <h2 class="text-xs font-black text-[#a1887f] uppercase tracking-widest mb-4">Riwayat Draf</h2>
                <div id="draft-list" class="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-xs text-slate-400 italic text-center py-4">Memuat data...</p>
                </div>
            </div>
        </div>

        <!-- MAIN INVOICE PAPER -->
        <div id="invoice-paper" class="invoice-paper">
            <!-- Logo Section -->
            <div class="flex justify-between items-start mb-16">
                <div class="flex flex-col gap-2">
                    <div class="relative group">
                        <input type="file" id="logo-upload" class="hidden" accept="image/*">
                        <div id="logo-container" onclick="document.getElementById('logo-upload').click()" class="min-w-[10rem] min-h-[5rem] flex flex-col items-center justify-center cursor-pointer hover:bg-[#fdfaf6] transition-all overflow-hidden relative border-none">
                            <div id="logo-placeholder" class="hidden text-center p-4">
                                <svg class="mx-auto text-[#d2b48c]" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                <p class="text-[9px] font-bold text-[#a1887f] mt-2 uppercase tracking-tighter text-center">Upload Logo</p>
                            </div>
                            <img id="logo-img" class="h-auto object-contain w-[160px] hidden" src="">
                            <button onclick="event.stopPropagation(); removeLogo()" id="remove-logo" class="no-print absolute -top-1 -right-1 bg-red-400 text-white rounded-full p-1 shadow-md hover:bg-red-500 transition-colors hidden">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div id="logo-size-control" class="no-print flex flex-col gap-1 px-1 hidden">
                        <label class="text-[8px] font-black text-[#d2b48c] uppercase tracking-widest">Resize</label>
                        <input type="range" id="logo-size-slider" min="50" max="350" value="160" oninput="resizeLogo(this.value)" class="w-full h-1 bg-[#eaddd0] rounded-lg appearance-none cursor-pointer accent-[#8b5a2b]">
                    </div>
                </div>

                <div class="text-right">
                    <h2 contenteditable="true" id="inv-title" class="text-5xl font-black text-[#8b5a2b] italic tracking-tighter mb-1 uppercase">INVOICE</h2>
                    <div class="text-[#8d6e63] font-bold text-sm">
                        <p># <span contenteditable="true" id="inv-no">INV/2026/001</span></p>
                        <p class="mt-0.5"><span contenteditable="true" id="inv-date-label">Tanggal:</span> <span contenteditable="true" id="inv-date">26 Feb 2026</span></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-12 mb-12">
                <div>
                    <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-3 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Pengirim</h3>
                    <div contenteditable="true" id="from-info" class="text-sm font-semibold text-[#5d4037] leading-relaxed whitespace-pre-line">
                        Nama Perusahaan Anda
                        Jl. Contoh No. 123, Kota
                    </div>
                </div>
                <div class="text-right">
                    <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-3 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Penerima</h3>
                    <div contenteditable="true" id="to-info" class="text-sm font-semibold text-[#5d4037] leading-relaxed whitespace-pre-line">
                        Nama Customer / Instansi
                        Alamat Lengkap Customer
                    </div>
                </div>
            </div>

            <!-- TABLE TOOLBAR (Alignment & Global Actions) -->
            <div id="table-toolbar" class="no-print mb-4 flex items-center justify-between bg-[#fdfaf6] p-2 rounded-xl border border-[#eaddd0]">
                <div class="flex items-center gap-4">
                    <span class="text-[9px] font-black text-[#a1887f] uppercase tracking-widest pl-2">Perataan Baris:</span>
                    <div class="flex bg-white rounded-lg border border-[#eaddd0] overflow-hidden shadow-sm">
                        <button onclick="setItemAlignment('left')" id="align-btn-left" title="Rata Kiri" class="p-2 text-[#8d6e63] hover:bg-[#f7f3f0] transition-colors">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
                        </button>
                        <button onclick="setItemAlignment('center')" id="align-btn-center" title="Rata Tengah" class="p-2 text-[#8d6e63] hover:bg-[#f7f3f0] border-x border-[#eaddd0] transition-colors">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>
                        </button>
                        <button onclick="setItemAlignment('right')" id="align-btn-right" title="Rata Kanan" class="p-2 text-[#8d6e63] hover:bg-[#f7f3f0] transition-colors">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="text-[9px] font-bold text-[#d2b48c] italic pr-2" id="toolbar-status">
                    Klik rincian pekerjaan untuk mengatur rata teks
                </div>
            </div>

            <!-- Table -->
            <div class="mb-8 overflow-hidden">
                <table class="w-full border-spacing-0" id="main-invoice-table">
                    <thead>
                        <tr class="bg-[#5d4037] text-[#f7f3f0]">
                            <th class="py-3 px-2 w-10 text-center text-[9px] uppercase font-black rounded-l-lg">No</th>
                            <th class="py-3 px-4 text-[9px] uppercase font-black text-left">Item Pekerjaan</th>
                            <th class="py-3 px-2 w-16 text-center text-[9px] uppercase font-black">Qty</th>
                            <th class="py-3 px-2 w-20 text-center text-[9px] uppercase font-black">Satuan</th>
                            <th class="py-3 px-2 w-32 text-right text-[9px] uppercase font-black">Harga (Sat)</th>
                            <th class="py-3 px-4 w-36 text-right text-[9px] uppercase font-black rounded-r-lg">Total</th>
                        </tr>
                    </thead>
                    <tbody id="items-body">
                        <!-- JS Render -->
                    </tbody>
                </table>
                <button onclick="addItem()" class="no-print mt-6 flex items-center gap-1.5 text-[#a0522d] font-black text-[10px] uppercase tracking-wider hover:text-[#8b4513] transition-all px-2">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Tambah Baris Baru
                </button>
            </div>

            <div class="mb-12">
                <h3 class="text-[10px] uppercase font-black text-[#d2b48c] mb-2 border-b-2 border-[#fdfaf6] tracking-[0.2em]">Catatan</h3>
                <div contenteditable="true" id="invoice-notes" class="text-[11px] font-medium text-[#8d6e63] leading-relaxed min-h-[4rem] whitespace-pre-line">
                    * Pembayaran melalui Bank XXXX: 1234-5678-90 (A/N Nama Anda)
                </div>
            </div>

            <!-- TOTALS SECTION -->
            <div class="flex justify-end pt-8 border-t-4 border-[#f7f3f0]">
                <div class="w-full md:w-[26rem] space-y-3">
                    <div class="flex justify-between items-center text-sm font-bold text-[#d2b48c] px-4">
                        <span>Subtotal:</span>
                        <span id="p-subtotal">Rp 0</span>
                    </div>

                    <!-- Discount Section -->
                    <div class="no-print flex items-center justify-between bg-[#fdfaf6] p-2 rounded-xl border border-[#eaddd0] mx-4">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] font-black text-[#a1887f] uppercase">Diskon</span>
                            <div class="flex bg-white rounded-md border border-[#eaddd0] overflow-hidden text-[9px]">
                                <button onclick="setDiscountMode('percent')" id="disc-mode-pct" class="px-2 py-1 font-black bg-[#a0522d] text-white">%</button>
                                <button onclick="setDiscountMode('fixed')" id="disc-mode-fix" class="px-2 py-1 font-black text-[#d2b48c]">Rp</button>
                            </div>
                        </div>
                        <input type="number" id="discount-input" value="0" oninput="calculateTotals()" class="bg-transparent text-right font-black text-[#a0522d] outline-none w-24 text-sm">
                    </div>

                    <div class="flex justify-between items-center text-2xl font-black text-white wood-gradient p-5 rounded-2xl shadow-xl mx-4">
                        <span class="tracking-tighter italic text-base">TOTAL</span>
                        <span id="p-total">Rp 0</span>
                    </div>

                    <!-- PAYMENT STAGES (DP BERTAHAP DENGAN TANGGAL) -->
                    <div id="stages-container" class="space-y-2 mt-4">
                        <div class="flex items-center justify-between px-4">
                            <h4 class="text-[10px] font-black text-[#8b5a2b] uppercase tracking-widest">Tahapan Pembayaran</h4>
                            <button onclick="addStage()" class="no-print bg-[#f1f8e9] text-[#558b2f] p-1 rounded-md hover:bg-[#558b2f] hover:text-white transition-all">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>

                        <div id="stages-list">
                            <!-- JS Rendered Stages -->
                        </div>

                        <div id="balance-row" class="hidden flex justify-between items-center text-lg font-black text-[#5d4037] border-t-2 border-[#f7f3f0] pt-4 px-4 mx-4">
                            <span class="uppercase tracking-widest text-[11px]">Sisa Pelunasan</span>
                            <span id="p-balance" class="text-[#a0522d]">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signatures -->
            <div class="mt-24 grid grid-cols-2 gap-16 text-center">
                <div>
                    <p contenteditable="true" id="to-label" class="text-[10px] uppercase font-black text-[#d2b48c] mb-20 tracking-[0.2em]">Diterima Oleh,</p>
                    <div class="border-b-2 border-[#eaddd0] mx-auto w-48 mb-2"></div>
                    <div contenteditable="true" id="to-name" class="font-black text-[#5d4037] tracking-tight uppercase">( Nama Penerima )</div>
                </div>
                <div>
                    <p contenteditable="true" id="from-label" class="text-[10px] uppercase font-black text-[#d2b48c] mb-20 tracking-[0.2em]">Hormat Kami,</p>
                    <div class="border-b-2 border-[#eaddd0] mx-auto w-48 mb-2"></div>
                    <div contenteditable="true" id="from-name" class="font-black text-[#5d4037] tracking-tight uppercase">( Penanggung Jawab )</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 wood-gradient text-white px-8 py-3 rounded-full text-[10px] font-black uppercase tracking-widest opacity-0 transition-all duration-300 pointer-events-none z-[100] shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userProvidedConfig = {
            apiKey: "AIzaSyAycsHtCJTx5vFzt-Ts7C4b-TC6XPg0Jew",
            authDomain: "cloud-invoice-31eb4.firebaseapp.com",
            projectId: "cloud-invoice-31eb4",
            storageBucket: "cloud-invoice-31eb4.firebasestorage.app",
            messagingSenderId: "581810444397",
            appId: "1:581810444397:web:3c677edd12f5258ed34764"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'invoice-cloud-v2';

        let currentUser = null;
        let currentDraftId = null;
        let activeItemId = null; // Track focused item for alignment toolbar
        let items = [{ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false, alignment: 'left' }];
        let paymentStages = []; // { id, label, value, mode: 'percent'|'fixed', date: 'YYYY-MM-DD' }
        let discountMode = 'percent';
        let logoBase64 = null;
        let logoWidth = 160;

        // HELPER: Auto Resize Textarea
        window.autoResize = (el) => {
            if (!el) return;
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        };

        // AUTH INITIALIZATION
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) { updateCloudStatus('error'); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                updateCloudStatus('connected');
                listenToDrafts();
            }
        });

        // CORE FUNCTIONS
        window.addItem = () => {
            items.push({ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false, alignment: 'left' });
            renderItems();
        };

        window.removeItem = (id) => {
            if (items.length > 1) {
                items = items.filter(i => i.id !== id);
                if (activeItemId === id) activeItemId = null;
                renderItems();
            }
        };

        window.updateItem = (id, field, val) => {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = (field === 'quantity' || field === 'price') ? (parseFloat(val) || 0) : val;
                calculateTotals();
            }
        };

        window.toggleHeader = (id) => {
            const item = items.find(i => i.id === id);
            if (item) { item.isHeader = !item.isHeader; renderItems(); }
        };

        window.setActiveItem = (id) => {
            activeItemId = id;
            const item = items.find(i => i.id === id);
            
            // Highlight active row visually
            document.querySelectorAll('#items-body tr').forEach(row => row.classList.remove('active-row'));
            const currentRow = document.getElementById(`row-${id}`);
            if (currentRow) currentRow.classList.add('active-row');
            
            // Update Toolbar Status & Buttons
            updateToolbarUI(item.alignment);
            document.getElementById('toolbar-status').textContent = `Mengatur perataan baris ke-${items.indexOf(item) + 1}`;
        };

        window.setItemAlignment = (align) => {
            if (!activeItemId) return;
            const item = items.find(i => i.id === activeItemId);
            if (item) {
                item.alignment = align;
                updateToolbarUI(align);
                
                // Update only the textarea alignment without full re-render to keep focus
                const textarea = document.getElementById(`area-${activeItemId}`);
                if (textarea) {
                    textarea.classList.remove('text-left', 'text-center', 'text-right');
                    textarea.classList.add(`text-${align}`);
                }
            }
        };

        function updateToolbarUI(align) {
            const btns = {
                'left': document.getElementById('align-btn-left'),
                'center': document.getElementById('align-btn-center'),
                'right': document.getElementById('align-btn-right')
            };
            
            Object.keys(btns).forEach(key => {
                if (key === align) {
                    btns[key].classList.add('bg-[#8b5a2b]', 'text-white');
                    btns[key].classList.remove('hover:bg-[#f7f3f0]', 'text-[#8d6e63]');
                } else {
                    btns[key].classList.remove('bg-[#8b5a2b]', 'text-white');
                    btns[key].classList.add('hover:bg-[#f7f3f0]', 'text-[#8d6e63]');
                }
            });
        }

        // DP BERTAP (STAGES) FUNCTIONS
        window.addStage = () => {
            const today = new Date().toISOString().split('T')[0];
            paymentStages.push({ 
                id: Date.now(), 
                label: `DP Tahap ${paymentStages.length + 1}`, 
                value: 0, 
                mode: 'fixed',
                date: today
            });
            renderStages();
        };

        window.removeStage = (id) => {
            paymentStages = paymentStages.filter(s => s.id !== id);
            renderStages();
        };

        window.updateStage = (id, field, val) => {
            const stage = paymentStages.find(s => s.id === id);
            if (stage) {
                stage[field] = field === 'value' ? (parseFloat(val) || 0) : val;
                if (field === 'date') renderStages(); 
                calculateTotals();
            }
        };

        window.setStageMode = (id, mode) => {
            const stage = paymentStages.find(s => s.id === id);
            if (stage) {
                stage.mode = mode;
                renderStages();
            }
        };

        window.setDiscountMode = (mode) => {
            discountMode = mode;
            const pctBtn = document.getElementById('disc-mode-pct');
            const fixBtn = document.getElementById('disc-mode-fix');
            pctBtn.className = mode === 'percent' ? 'px-2 py-1 font-black bg-[#a0522d] text-white' : 'px-2 py-1 font-black text-[#d2b48c]';
            fixBtn.className = mode === 'fixed' ? 'px-2 py-1 font-black bg-[#a0522d] text-white' : 'px-2 py-1 font-black text-[#d2b48c]';
            calculateTotals();
        };

        // RENDERING
        window.renderItems = () => {
            const tbody = document.getElementById('items-body');
            tbody.innerHTML = '';
            let counter = 0;
            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.id = `row-${item.id}`;
                tr.className = `border-b border-[#f7f3f0] group hover:bg-[#fdfaf6] transition-all ${item.isHeader ? 'bg-[#fdfaf6] font-bold' : ''} ${activeItemId === item.id ? 'active-row' : ''}`;
                
                const displayNo = item.isHeader ? (++counter) : '';
                const alignClass = `text-${item.alignment || 'left'}`;
                
                tr.innerHTML = `
                    <td class="py-4 px-2 text-center text-xs text-[#a1887f] font-bold align-top">${displayNo}</td>
                    <td class="py-4 px-4 relative align-top">
                        <div class="no-print absolute -left-12 top-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick="removeItem(${item.id})" title="Hapus" class="bg-red-50 text-red-500 p-1 rounded hover:bg-red-500 hover:text-white">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                            <button onclick="toggleHeader(${item.id})" title="Header" class="p-1 rounded ${item.isHeader ? 'bg-[#a0522d] text-white' : 'bg-[#eaddd0] text-[#8d6e63] hover:bg-[#d2b48c]'}">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                            </button>
                        </div>
                        <textarea id="area-${item.id}" 
                            onfocus="setActiveItem(${item.id})"
                            oninput="updateItem(${item.id}, 'description', this.value); autoResize(this)" 
                            placeholder="${item.isHeader ? 'Nama Area/Grup...' : 'Rincian item...'}" 
                            class="item-textarea ${alignClass} ${item.isHeader ? 'font-extrabold text-[#8b5a2b]' : 'font-semibold text-[#5d4037]'}">${item.description}</textarea>
                    </td>
                    <td class="py-4 px-2 align-top"><input type="number" value="${item.quantity}" oninput="updateItem(${item.id}, 'quantity', this.value)" class="w-full text-center bg-transparent font-bold text-[#5d4037] outline-none ${item.isHeader ? 'invisible' : ''}"></td>
                    <td class="py-4 px-2 align-top"><input type="text" value="${item.unit}" placeholder="..." oninput="updateItem(${item.id}, 'unit', this.value)" class="w-full text-center bg-transparent font-bold text-[#a1887f] outline-none text-[11px] ${item.isHeader ? 'invisible' : ''}"></td>
                    <td class="py-4 px-2 align-top"><input type="number" value="${item.price}" oninput="updateItem(${item.id}, 'price', this.value)" class="w-full text-right bg-transparent font-bold text-[#5d4037] outline-none ${item.isHeader ? 'invisible' : ''}"></td>
                    <td class="py-4 px-4 text-right font-black text-[#5d4037] text-sm align-top ${item.isHeader ? 'invisible' : ''}">${formatCurrency(item.quantity * item.price)}</td>
                `;
                tbody.appendChild(tr);
                autoResize(document.getElementById(`area-${item.id}`));
            });
            calculateTotals();
        };

        window.renderStages = () => {
            const list = document.getElementById('stages-list');
            list.innerHTML = '';
            
            paymentStages.forEach(s => {
                const div = document.createElement('div');
                div.className = "group flex flex-col gap-1 mx-4 mb-3 border-b border-[#f7f3f0] pb-2 last:border-none";
                div.innerHTML = `
                    <div class="flex justify-between items-start text-[11px] font-bold text-[#558b2f] italic">
                        <div class="flex flex-col">
                            <span contenteditable="true" onblur="updateStage(${s.id}, 'label', this.textContent)" class="outline-none border-b border-transparent hover:border-[#c5e1a5]">${s.label}</span>
                            <span class="text-[9px] text-[#8d6e63] font-medium not-italic">Tgl: ${formatDateId(s.date)}</span>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="removeStage(${s.id})" class="no-print opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-all">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                             </button>
                             <span class="text-right">- ${formatStageValue(s)}</span>
                        </div>
                    </div>
                    <div class="no-print flex items-center justify-between bg-[#f1f8e9] p-2 rounded-xl border border-[#c5e1a5] mt-1 gap-2">
                        <div class="flex items-center gap-2">
                            <div class="flex bg-white rounded-md border border-[#c5e1a5] overflow-hidden text-[9px]">
                                <button onclick="setStageMode(${s.id}, 'percent')" class="px-2 py-1 font-black ${s.mode === 'percent' ? 'bg-[#689f38] text-white' : 'text-[#9ccc65]'}">%</button>
                                <button onclick="setStageMode(${s.id}, 'fixed')" class="px-2 py-1 font-black ${s.mode === 'fixed' ? 'bg-[#689f38] text-white' : 'text-[#9ccc65]'}">Rp</button>
                            </div>
                            <input type="date" value="${s.date}" oninput="updateStage(${s.id}, 'date', this.value)" class="text-[10px] bg-white border border-[#c5e1a5] rounded px-1 text-[#33691e] font-bold outline-none">
                        </div>
                        <input type="number" value="${s.value}" oninput="updateStage(${s.id}, 'value', this.value)" class="bg-transparent text-right font-black text-[#33691e] outline-none w-20 text-sm">
                    </div>
                `;
                list.appendChild(div);
            });
            calculateTotals();
        };

        window.calculateTotals = () => {
            const subtotal = items.reduce((sum, i) => sum + (i.isHeader ? 0 : (i.quantity * i.price)), 0);
            const discVal = parseFloat(document.getElementById('discount-input').value) || 0;
            const discAmount = discountMode === 'percent' ? (subtotal * discVal / 100) : discVal;
            const total = Math.max(0, subtotal - discAmount);

            let totalPaidStages = 0;
            paymentStages.forEach(s => {
                const amt = s.mode === 'percent' ? (total * s.value / 100) : s.value;
                totalPaidStages += amt;
            });

            const balance = Math.max(0, total - totalPaidStages);

            document.getElementById('p-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('p-total').textContent = formatCurrency(total);
            document.getElementById('p-balance').textContent = formatCurrency(balance);
            
            const balanceRow = document.getElementById('balance-row');
            if (paymentStages.length > 0) balanceRow.classList.remove('hidden');
            else balanceRow.classList.add('hidden');
        };

        function formatStageValue(s) {
            const subtotal = items.reduce((sum, i) => sum + (i.isHeader ? 0 : (i.quantity * i.price)), 0);
            const discVal = parseFloat(document.getElementById('discount-input').value) || 0;
            const discAmount = discountMode === 'percent' ? (subtotal * discVal / 100) : discVal;
            const total = subtotal - discAmount;
            
            const amt = s.mode === 'percent' ? (total * s.value / 100) : s.value;
            return formatCurrency(amt);
        }

        // HELPERS
        function formatDateId(dateStr) {
            if (!dateStr) return "-";
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return new Date(dateStr).toLocaleDateString('id-ID', options);
        }

        function formatCurrency(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
        
        function showToast(m) {
            const t = document.getElementById('toast');
            t.textContent = m; t.classList.add('opacity-100', 'translate-y-[-10px]');
            setTimeout(() => t.classList.remove('opacity-100', 'translate-y-[-10px]'), 3000);
        }

        // LOGO HANDLING
        document.getElementById('logo-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => { logoBase64 = event.target.result; displayLogo(logoBase64); };
                reader.readAsDataURL(file);
            }
        };

        function displayLogo(src, width) {
            const img = document.getElementById('logo-img');
            const placeholder = document.getElementById('logo-placeholder');
            const removeBtn = document.getElementById('remove-logo');
            const control = document.getElementById('logo-size-control');
            logoWidth = width || 160;
            img.src = src; img.style.width = `${logoWidth}px`;
            img.classList.remove('hidden'); placeholder.classList.add('hidden');
            removeBtn.classList.remove('hidden'); control.classList.remove('hidden');
        }

        window.removeLogo = () => {
            logoBase64 = null;
            document.getElementById('logo-img').classList.add('hidden');
            document.getElementById('logo-placeholder').classList.remove('hidden');
            document.getElementById('remove-logo').classList.add('hidden');
            document.getElementById('logo-size-control').classList.add('hidden');
        };

        window.resizeLogo = (val) => { logoWidth = val; document.getElementById('logo-img').style.width = `${val}px`; };

        // FIREBASE DRAFT SYSTEM
        window.createNewInvoice = () => {
            currentDraftId = null;
            activeItemId = null;
            items = [{ id: Date.now(), description: '', quantity: 1, price: 0, unit: '', isHeader: false, alignment: 'left' }];
            paymentStages = [];
            document.getElementById('inv-no').textContent = `INV/${new Date().getFullYear()}/${Math.floor(Math.random()*999).toString().padStart(3,'0')}`;
            renderItems();
            renderStages();
            showToast("Invoice Baru");
        };

        window.saveDraft = async () => {
            if (!currentUser) return showToast("Gagal (Offline)");
            const id = currentDraftId || crypto.randomUUID();
            const data = {
                invTitle: document.getElementById('inv-title').textContent,
                invNo: document.getElementById('inv-no').textContent,
                invDate: document.getElementById('inv-date').textContent,
                fromInfo: document.getElementById('from-info').textContent,
                toInfo: document.getElementById('to-info').textContent,
                notes: document.getElementById('invoice-notes').textContent,
                fromName: document.getElementById('from-name').textContent,
                toName: document.getElementById('to-name').textContent,
                items,
                paymentStages,
                discountValue: parseFloat(document.getElementById('discount-input').value) || 0,
                discountMode,
                logo: logoBase64,
                logoWidth,
                updatedAt: serverTimestamp()
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id), data);
                currentDraftId = id;
                showToast("Tersimpan");
            } catch (e) { showToast("Gagal Simpan"); }
        };

        function listenToDrafts() {
            onSnapshot(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices'), (snap) => {
                const list = document.getElementById('draft-list');
                list.innerHTML = '';
                if (snap.empty) { list.innerHTML = '<p class="text-[10px] text-slate-400 text-center py-4">Kosong</p>'; return; }
                snap.docs.forEach(docSnap => {
                    const d = docSnap.data();
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl border text-[11px] cursor-pointer transition-all ${currentDraftId === docSnap.id ? 'wood-gradient text-white border-transparent' : 'bg-white border-[#eaddd0] text-[#8d6e63]'}`;
                    div.onclick = () => loadDraft(docSnap.id);
                    div.innerHTML = `<div class="flex justify-between font-black"><span>${d.invNo}</span><button onclick="event.stopPropagation(); deleteDraft('${docSnap.id}')" class="opacity-50 hover:opacity-100">âœ•</button></div>`;
                    list.appendChild(div);
                });
            });
        }

        window.loadDraft = (id) => {
            onSnapshot(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id), (snap) => {
                if (!snap.exists()) return;
                const d = snap.data();
                currentDraftId = id;
                document.getElementById('inv-title').textContent = d.invTitle;
                document.getElementById('inv-no').textContent = d.invNo;
                document.getElementById('inv-date').textContent = d.invDate;
                document.getElementById('from-info').textContent = d.fromInfo;
                document.getElementById('to-info').textContent = d.toInfo;
                document.getElementById('invoice-notes').textContent = d.notes;
                document.getElementById('from-name').textContent = d.fromName;
                document.getElementById('to-name').textContent = d.toName;
                document.getElementById('discount-input').value = d.discountValue || 0;
                discountMode = d.discountMode || 'percent';
                items = d.items;
                paymentStages = d.paymentStages || [];
                logoBase64 = d.logo;
                logoWidth = d.logoWidth || 160;
                if (logoBase64) displayLogo(logoBase64, logoWidth); else removeLogo();
                setDiscountMode(discountMode);
                renderItems();
                renderStages();
            }, {onlyOnce: true});
        };

        window.deleteDraft = async (id) => {
            if (confirm("Hapus draf ini?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'invoices', id));
                if (currentDraftId === id) createNewInvoice();
            }
        };

        function updateCloudStatus(s) {
            const el = document.getElementById('cloud-status');
            const dot = el.querySelector('span');
            if (s === 'connected') {
                el.className = "flex items-center gap-1.5 text-[10px] font-bold uppercase px-3 py-1 rounded-full bg-[#f1f8e9] text-[#558b2f] border border-[#c5e1a5]";
                dot.className = "w-2 h-2 rounded-full bg-[#8bc34a] animate-pulse";
                el.lastChild.textContent = "Online";
            }
        }

        document.getElementById('btn-save').onclick = window.saveDraft;
        window.renderItems();
    </script>
</body>
</html>
